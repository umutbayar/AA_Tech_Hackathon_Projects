<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AA Sentinel | Duygu Kontrol Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --aa-dark: #343a40; }
        body { background-color: #f8f9fa; }
        .header-section { background-color: var(--aa-dark); color: white; padding: 20px 0; margin-bottom: 30px; }
        .metric-card { border-left: 5px solid var(--aa-dark); }
    </style>
</head>
<body>

    <div class="header-section text-center">
        <div class="container">
            <h1>AA <span style="color: #ffc107;">Sentinel</span></h1>
            <p class="lead">Sosyal Medya Duygu Takip Paneli</p>
        </div>
    </div>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card metric-card bg-light p-3 text-center">
                    <h5 class="text-primary">Toplam Yorum</h5>
                    <h2 id="totalCount">0</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card p-3 text-center" style="border-left-color: #28a745;">
                    <h5 class="text-success">Pozitif (%)</h5>
                    <h2 id="positivePct">0%</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card p-3 text-center" style="border-left-color: #dc3545;">
                    <h5 class="text-danger">Negatif (%)</h5>
                    <h2 id="negativePct">0%</h2>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card p-3 shadow-sm">
                    <h5 class="card-title">Duygu Dağılımı (Anlık)</h5>
                    <canvas id="sentimentPieChart"></canvas>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card p-3 shadow-sm">
                    <h5 class="card-title">Son Yorumlar</h5>
                    <ul class="list-group list-group-flush" id="recentCommentsList">
                        </ul>
                </div>
            </div>
        </div>

        <div class="text-center mt-3 mb-5">
            <button class="btn btn-warning" id="refreshBtn">Verileri Yenile</button>
        </div>
    </div>

    <script>
        let pieChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            fetchMetrics();
            document.getElementById('refreshBtn').addEventListener('click', fetchMetrics);
        });

        function updateChart(counts) {
            const ctx = document.getElementById('sentimentPieChart').getContext('2d');
            const dataLabels = ['Pozitif', 'Negatif', 'Nötr'];
            const dataValues = [counts.Pozitif, counts.Negatif, counts.Nötr];
            const backgroundColors = ['#28a745', '#dc3545', '#ffc107']; // Yeşil, Kırmızı, Sarı

            // Önceki grafiği yok et
            if (pieChart) {
                pieChart.destroy();
            }

            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: dataLabels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: (context) => {
                            let label = context.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed !== null) { label += context.parsed + ' adet'; }
                            return label;
                        }}}
                    }
                }
            });
        }

        function fetchMetrics() {
            document.getElementById('refreshBtn').disabled = true;

            fetch('/api/metrics')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('refreshBtn').disabled = false;
                    const metrics = data.metrics;

                    // Metrikleri Güncelle
                    document.getElementById('totalCount').textContent = metrics.total_comments;
                    document.getElementById('positivePct').textContent = `${metrics.sentiment_percentages.Pozitif.toFixed(1)}%`;
                    document.getElementById('negativePct').textContent = `${metrics.sentiment_percentages.Negatif.toFixed(1)}%`;
                    
                    // Grafik Güncelle
                    updateChart(metrics.sentiment_counts);

                    // Son Yorumlar Güncelle
                    const commentsList = document.getElementById('recentCommentsList');
                    commentsList.innerHTML = '';
                    metrics.recent_comments.forEach(item => {
                        const sentimentClass = item.sentiment === 'Pozitif' ? 'text-success' 
                                             : item.sentiment === 'Negatif' ? 'text-danger' 
                                             : 'text-warning';
                        
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-start';
                        listItem.innerHTML = `
                            <div class="ms-2 me-auto">
                                <div>${item.comment}</div>
                                <small class="text-muted">${item.timestamp} | Kategori: ${item.keyword}</small>
                            </div>
                            <span class="badge ${sentimentClass} rounded-pill">${item.sentiment}</span>
                        `;
                        commentsList.appendChild(listItem);
                    });
                })
                .catch(error => {
                    document.getElementById('refreshBtn').disabled = false;
                    console.error('Veri çekme hatası:', error);
                    alert('Veri çekilirken bir hata oluştu. Konsolu kontrol edin.');
                });
        }
    </script>
</body>
</html>