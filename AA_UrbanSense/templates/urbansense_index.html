<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AA UrbanSense | AkÄ±llÄ± Åžehir Veri Hub'Ä±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --aa-dark: #343a40; }
        body { background-color: #f8f9fa; }
        .header-section { background-color: var(--aa-dark); color: white; padding: 20px 0; margin-bottom: 30px; }
        .kriz-uyari { border: 3px solid #dc3545; background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <div class="header-section text-center">
        <div class="container">
            <h1>AA <span style="color: #ffc107;">UrbanSense</span></h1>
            <p class="lead">Trafik, Ã‡evre ve Sosyal Medya Veri Analiz Merkezi</p>
        </div>
    </div>

    <div class="container">
        <div id="krizAlert" class="alert kriz-uyari text-center mb-4" role="alert" style="display: none;">
            <h4 class="alert-heading">ðŸš¨ KRÄ°TÄ°K KRÄ°Z TESPÄ°T EDÄ°LDÄ°!</h4>
            <p id="krizMesaj"></p>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card p-3 text-center metric-card" style="border-left-color: #007bff;">
                    <h5 class="text-primary">Ort. PM10 (Ã‡evre)</h5>
                    <h2 id="pm10Metric">--</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 text-center metric-card" style="border-left-color: #ffc107;">
                    <h5 class="text-warning">Kaza SayÄ±sÄ± (Trafik)</h5>
                    <h2 id="kazaMetric">--</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 text-center metric-card" style="border-left-color: #dc3545;">
                    <h5 class="text-danger">Negatif Duygu OranÄ± (SM)</h5>
                    <h2 id="negatifMetric">--</h2>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card p-3 shadow-sm">
                    <h5 class="card-title">TemizlenmiÅŸ Veri Ã–zeti (Ä°lk 5 KayÄ±t)</h5>
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Zaman</th>
                                <th>BÃ¶lge</th>
                                <th>HÄ±z (km/h)</th>
                                <th>PM10</th>
                                <th>HKÄ°</th>
                                <th>Duygu</th>
                            </tr>
                        </thead>
                        <tbody id="veriTablosu">
                            <tr><td colspan="6" class="text-center">Veriler yÃ¼kleniyor...</td></tr>
                        </tbody>
                    </table>
                    <button class="btn btn-primary mt-3" onclick="fetchAnalysis()">Analizi Yenile</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', fetchAnalysis);

        function fetchAnalysis() {
            const btn = document.querySelector('button');
            btn.disabled = true;
            
            fetch('/api/analyze')
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    const metrics = data.metrikler;
                    const kriz = data.kriz_durumu;

                    // 1. Kriz UyarÄ±sÄ±nÄ± GÃ¼ncelle
                    const alertDiv = document.getElementById('krizAlert');
                    const krizMesaj = document.getElementById('krizMesaj');

                    if (kriz.tespit_edildi) {
                        alertDiv.style.display = 'block';
                        krizMesaj.textContent = kriz.mesaj;
                    } else {
                        alertDiv.style.display = 'none';
                    }

                    // 2. Metrikleri GÃ¼ncelle
                    document.getElementById('pm10Metric').textContent = metrics.ortalama_pm10.toFixed(2);
                    document.getElementById('kazaMetric').textContent = metrics.kaza_sayisi;
                    document.getElementById('negatifMetric').textContent = `${(metrics.negatif_duygu_orani * 100).toFixed(1)}%`;

                    // 3. Veri Tablosunu GÃ¼ncelle
                    const tabloBody = document.getElementById('veriTablosu');
                    tabloBody.innerHTML = '';

                    data.sonuclar.forEach(item => {
                        const row = tabloBody.insertRow();
                        row.insertCell().textContent = new Date(item.timestamp).toLocaleTimeString('tr-TR');
                        row.insertCell().textContent = item.bolge;
                        row.insertCell().textContent = item.ortalama_hiz_kmh.toFixed(1);
                        row.insertCell().textContent = item.pm10.toFixed(1);
                        row.insertCell().textContent = item.hava_kalitesi;
                        row.insertCell().textContent = item.sosyal_medya_duygu;
                    });
                })
                .catch(error => {
                    btn.disabled = false;
                    console.error('Analiz hatasÄ±:', error);
                    alert('Veri analizi yapÄ±lÄ±rken bir hata oluÅŸtu.');
                });
        }
    </script>
</body>
</html>